const dbo=require("../db/conn"),ObjectId=require("mongodb").ObjectId,unpacker=require("unpacker"),axios=require("axios"),fs=require("fs"),{decodingCanvas:decodingCanvas}=require("../decode_image"),{writer:writer}=require("repl"),{resolve:resolve}=require("path"),{rejects:rejects}=require("assert");async function check(e){return new Promise((o,r)=>{setTimeout(()=>{fs.readFile(e,"utf8",function(e,r){if(!e)return console.log("Get the file..."),o(!0);check()})},5e3)})}exports.log_list=((e,o)=>{o.json({status:"connected"})}),exports.decoding=((e,o)=>{console.log("post decoding...");var r=e.body,c=unpacker.unpack(r),n=/(?<=sovleImage=)(\[\[.*]];)/.exec(c);return console.log(n[0]),o.json({message:"successfully",url:n[0]})}),exports.download=(async(e,o)=>{objDownload={},console.log("Downloading...");const r=e.body,c=r.url,n=r.script;/<script>\s*(.+?)\s*\<\/script>/.exec('<script>eval(function(p,a,c,k,e,d){e=function(c){return c.toString(36)};if(!\'\'.replace(/^/,String)){while(c--){d[c.toString(a)]=k[c]||c.toString(a)}k=[function(e){return d[e]}];e=function(){return\'\\w+\'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp(\'\\b\'+e(c)+\'\\b\',\'g\'),k[c])}}return p}(\'8 a=q.l("k");8 e=a.o("n");8 9=m h;9.j=f(){e.g(9,0,0);8 6=[["0.4","0.4","0.4","0.4"],["5.4","7.4","0.4","7.4"],["5.4","0.4","0.4","d.4"],["5.4","c.4","0.4","c.4"],["0.4","c.4","0.4","b.4"],["0.4","7.4","5.4","0.4"],["5.4","b.4","5.4","7.4"],["5.4","d.4","5.4","d.4"],["0.4","d.4","5.4","c.4"],["0.4","b.4","5.4","b.4"]];r(8 i=0;i<6.s;i++){e.g(9,6[i][2],6[i][3],5,7,6[i][0],6[i][1],5,7)}};9.u=a.v("w-x");a.y=f(){t p}\',35,35,\'||||00|500|sovleImage|333|var|BDQIXimage|BDQIXcanvasRender|1332|999|666|BDQIXctx|function|drawImage|Image||onload|imageBDQIX2|getElementById|new|2d|getContext|false|document|for|length|return|src|getAttribute|data|url|oncontextmenu\'.split(\'|\'),0,{}))<\/script>')[1];var a=unpacker.unpack(n);let s=/for\s*\([^;]*?;[^;]*?;[^)]*?\)({)(.*)(}};)/.exec(a);console.log(s[0]),console.log("========> matchy: "),console.log(s);var t=s[0].split(",");let l=[],i=/\d+/;for(var g=0;g<t.length;g++){let e=parseInt(i.exec(t[g]));console.log(e),l.push(e)}console.log(`parameterDecode: ${l}`),console.log(`parameterDecode: ${l[4]}`),objDownload.parameter=l,console.log(objDownload.parameter);/\.drawImage\(.*sovleImage\[i]\[\d*],sovleImage\[i]\[\d*],\d*,\d*,sovleImage\[i]\[\d*],sovleImage\[i]\[\d*],\d*,\d*\)/i.exec(a);console.log("========> matches_first");var d=/(?<=sovleImage=)(\[\[.*]];)/.exec(a);console.log("sovle image"),console.log(d[0]);var u=d[0].split(",");u[0]=u[0].replace("[[",""),u[u.length-1]=u[u.length-1].replace("]]","");var p=[];let m=[];var f=/\d*\.?\d\d/;for(g=0;g<10;g++){for(var v=4*g,h=v;h<v+4;h++){let e=f.exec(u[h])[0],o=parseFloat(e);m.push(o)}p.push(m),m=[]}console.log(p);e.get("host");var b="./public/bot/";console.log(`URL BODY: ${c}`);const w=c;var x=w.substring(w.lastIndexOf("/")+1),I=`${b+x}`||"";console.log("Encoding Image: "+I);await axios.get(w,{responseType:"stream"}).then(e=>(fs.existsSync(b)||fs.mkdirSync(b,{recursive:!0}),e.data.pipe(fs.createWriteStream(`${b+x}`)))).then(async e=>{var o=await check(I);return console.log(`checker ====> ${o}`),o&&(console.log(`FileName ====> ${x}`),await decodingCanvas(p,I,objDownload,x)),e}).catch(e=>{console.log(e)}).finally(()=>{o.json({message:"successfully",filename:x}),console.log("Decoding Completed")})});